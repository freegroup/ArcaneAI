<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Adventure Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link href="./assets/main.css" rel="stylesheet"/>
    <link href="./assets/bubbles.css" rel="stylesheet"/>
</head>
<body>

<div id="welcome-container">
    <div class="background-image"></div>
    <div class="welcome-text">
        <div>
            Ein mysteriöser Fluch hält dich hier gefangen – dieser düstere Dungeon ist 
            das Einzige, was zwischen dir und deinem wohlverdienten, kalten Bier steht! 
            Nur ein Weg führt zur Freiheit: das sagenumwobene Goldene Ei finden und den 
            Bann brechen.
        </div>
        <div>
            Aber keine Sorge, du musst dich nicht selbst in Gefahr begeben! Ein treuer 
            Gefährte steht dir zur Seite und erledigt jede Herausforderung, die euch 
            begegnet. Gib ihm einfach klare Anweisungen – wie „Untersuche das Haus 
            mal genauer" oder „Schau dir den Baum an" – und er wird alles für dich erledigen.
        </div>
        <div>
            Bist du bereit? Drücke auf „Start" und tauche ein in die Welt des Dungeon Escape!
        </div>
    </div>
    <button id="startButton" onclick="startGame()">Start Game</button>
</div>

<div id="game-container">
    <div class="background-image"></div>
    <div id="game-status-container">
        <div>Deine Position:</div> 
        <div id="game-status-value"></div>
    </div>
    <div class="chat-container" id="chatContainer"></div>

    <div class="input-area" id="inputArea">
        <input type="text" id="question" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
    </div>
</div>

<script>
    const welcomeContainer = document.getElementById("welcome-container");
    const gameContainer = document.getElementById("game-container");
    const chatContainer = document.getElementById("chatContainer");
    const inputArea = document.getElementById("inputArea");
    const questionInput = document.getElementById("question");
    const gameStatus = document.getElementById("game-status-value");

    let typingIndicator = null;
    let websocket = null;
    let token = null;
    
    // WebSocket connection
    async function connectWebSocket() {
        try {
            // Get WebSocket token from server
            const response = await fetch("{{ BASE_URI }}/websocket/connect", {
                credentials: "include"
            });
            const data = await response.json();
            token = data.token;
            
            console.log('[WS] Got token, connecting...');
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}{{ BASE_URI }}/websocket/${token}`;
            
            console.log('[WS] Connecting to:', wsUrl);
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = () => {
                console.log('[WS] Connected!');
            };
            
            websocket.onmessage = (event) => {
            if (typeof event.data === "string") {
                try {
                    const message = JSON.parse(event.data);
                    console.log('[WS] Received:', message.type, message.data);
                    
                    if (message.type === 'inventory_update') {
                        console.log('[INVENTORY UPDATE]', message.data);
                        // Display inventory in console
                        console.table(message.data);
                    } else if (message.type === 'state_change') {
                        console.log('[STATE CHANGE]', message.data);
                        updateGameStatus(message.data.state);
                    } else if (message.type === 'connected') {
                        console.log('[WS] Initial state:', message.data);
                        updateGameStatus(message.data.state);
                    } else if (message.type === 'error') {
                        console.error('[WS ERROR]', message.data);
                    }
                } catch (error) {
                    console.error('[WS] Error parsing message:', error);
                }
            }
        };
        
            websocket.onerror = (error) => {
                console.error('[WS] Error:', error);
            };
            
            websocket.onclose = () => {
                console.log('[WS] Disconnected, reconnecting in 3s...');
                websocket = null;
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
        } catch (error) {
            console.error('[WS] Connection error:', error);
        }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            sendQuestion();
        }
    }

    async function startGame() {
        try {
            // 1. FIRST: Connect WebSocket (gets token and creates session)
            await connectWebSocket();
            
            // 2. THEN: Show UI
            toggleChatUI(true);
            showTypingIndicator();
            
            // 3. Start game
            const response = await fetch("{{ BASE_URI }}/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ text: "start" })
            });

            const data = await response.json();
            removeTypingIndicator();
            addMessage(data.response, "bot");
            updateGameStatus(data.state);
            
            questionInput.focus();
        } catch (error) {
            console.error("Error starting game:", error);
            removeTypingIndicator();
            addMessage("Error starting game.", "bot");
        }
    }

    async function sendQuestion() {
        const userMessage = questionInput.value.trim();
        questionInput.value = "";

        if (userMessage) {
            addMessage(userMessage, "user");
            showTypingIndicator();

            try {
                const response = await fetch("{{ BASE_URI }}/api/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ text: userMessage })
                });

                if (!response.ok) throw new Error(`Server error: ${response.status}`);

                const data = await response.json();
                removeTypingIndicator();
                addMessage(data.response, "bot");
                updateGameStatus(data.state);
            } catch (error) {
                console.error("Error:", error);
                removeTypingIndicator();
                addMessage("Error connecting to server.", "bot");
            }
        }
    }

    function showTypingIndicator() {
        if (!typingIndicator) {
            typingIndicator = document.createElement("div");
            typingIndicator.classList.add("typing-indicator");

            for (let i = 0; i < 3; i++) {
                const dot = document.createElement("div");
                dot.classList.add("dot");
                typingIndicator.appendChild(dot);
            }
            chatContainer.insertBefore(typingIndicator, chatContainer.firstChild);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }

    function removeTypingIndicator() {
        if (typingIndicator) {
            chatContainer.removeChild(typingIndicator);
            typingIndicator = null;
        }
    }

    function addMessage(text, sender) {
        const messageBubble = document.createElement("div");
        messageBubble.classList.add("message", sender, "cbbl");
        if(sender === "user"){
            messageBubble.classList.add("-right");
        }
        messageBubble.textContent = text;
        chatContainer.insertBefore(messageBubble, chatContainer.firstChild);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function updateGameStatus(state) {
        if (state) {
            gameStatus.textContent = state;
        }
    }

    function toggleChatUI(show) {
        welcomeContainer.style.display = show ? "none" : "flex";
        gameContainer.style.display = show ? "flex" : "none";
        if (show) {
            questionInput.focus();
        }
    }
</script>

</body>
</html>